<!DOCTYPE html>
  <html>
    <head>
      <meta charset="UTF-8">
      <meta name="apple-mobile-web-app-capable" content="yes">
      <meta name="viewport" content="initial-scale=1, user-scalable=no">
        
      <title>Nutrition</title>
      
    </head>
    <body>
      <style>
        *{
          padding: 0;
          margin: 0;
          
          box-sizing: content-box;
        }
        #container {
            height: 600px; 
            min-width: 600px; 
            max-width: 800px;
            margin: 0 auto;
        }
        .panel{
          width: 1024px;
          display: none;
        }
        .button-1{
          padding: 10px;
          border: 1px solid;
          position: absolute;
          z-index: 999;
        }
        .button-config{
          width: 50px;
          height: 50px;
          
          border: 1px solid;
          
          right: 0;
          top: 0;
          
          position: fixed;
          z-index: 999;
        }
        .button-reload{
          width: 50px;
          height: 50px;
          
          border: 1px solid;
          
          right: 0;
          bottom: 0;
          
          position: fixed;
          z-index: 999;
        }
      </style>
      
      <div class='wrapper'>
        <div class='panel' id='panel-00' style='display: block'>
          <p>Bạn có bị suy giảm sức khỏe và thiếu hụt dinh dưỡng không ?</p>
          <p class='button-1' id='btt-next-intro'>Kiểm tra ngay</p>          
          <br>
          <!--<div>
            <label for="tags">Tags: </label>
            <input id="tags">
          </div>-->
        </div>
        <div class='panel' id='panel-01'>
          <input id='input-name' placeholder='Name'/>
          <input id='input-address' placeholder='Address'/>
          <input id='input-phone' placeholder='Phone'/>
          
          <p class='button-1' id='btt-next-info'>Next</p> 
        </div>
        <div class='panel' id='panel-02'>
          
          Giới tính: <input type="radio" name="sex" value="0"/>Nam
          <input type="radio" name="sex" value="1"/>Nữ
          Lao động:  <input type="radio" value="0" name="type-work" >Nhẹ <input type="radio" value="1" name="type-work"> Trung bình <input type="radio" value="2" name="type-work"> Nặng
          Năm sinh: <input id='input-age' placeholder='19xx'/>
          <br>
          Bữa ăn :
          <select id='select-time-meal'>
            <option value="0">Sáng</option>
            <option value="1">Trưa</option>
            <option value="2">Chiều tối</option>
            <option value="3">Trái cây & thức uống</option>
          </select>
          Món ăn :          
          <select id='select-meal'>
            <option value="0">Bánh</option>
            <option value="1">Nước</option>
            <option value="2">Cơm</option>
            <option value="3">Ổi</option>
          </select>
          Số lượng : <input id='input-quantity' value='1'/>
          <input type='button' id='button-add-meal' value='Thêm vào'>
          <br>
          Nhập kết quả đo lực kéo : <input id='input-pull'/>
          <input type='button' value='Thêm vào'>
          <br>
          <table class="table">
            <thead class="fontTitle">
              <tr>
                <th style="width:40px">STT</th>
                <th style="width:180px">Bữa ăn</th>
                <th style="width:250px">Món ăn</th>
                <th style="width:80px">Số lượng</th>
                <th>Năng lượng<br/>(Kcal)</th>
                <th>Đạm<br/>(Kcal)</th>
                <th>Đường<br/>(Kcal)</th>
                <th>Béo<br/>(Kcal)</th>        
                <th>Vitamin<br/>(Kcal)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>1</td>
                <td>Sáng</td>
                <td>Cơm</td>
                <td>1</td>
                
                <td>1</td>                
                <td>1</td>
                <td>1</td>
                <td>1</td>
                <td>1</td>
              </tr>
              <tr>
                <td colspan="4">Năng lượng 1 ngày</td>
                <td>1</td>
                <td>1</td>
                <td>1</td>
                <td>1</td>     
                <td>1</td>
              </tr>
              <tr>
                <td colspan="5">Tỉ lệ phần trăm năng lượng trong 1 ngày</td>
                <td>1%</td>
                <td>1%</td>
                <td>1%</td>     
                <td></td>
              </tr>
              <tr>
                <td colspan="5">Kết quả đo lực kéo</td>
                <td>14</td>
                <td></td>
                <td></td>     
                <td></td>
              </tr>
            </tbody>
          </table>
          <br>
          <p class='button-1' id='btt-next-input'>Next</p> 
        
        
        </div>
        <div class='panel' id='panel-03'>
          <div id="container2" style="min-width: 310px; height: 400px; margin: 0 auto"></div>
          <br>
          <p class='button-1' id='btt-next-ptlk'>Next</p> 
        </div>
        <div class='panel' id='panel-04'>
          <div id="container" ></div>
          <br>
          <p class='button-1' id='btt-next-tpdd'>Next</p> 
        </div>
        <div class='panel' id='panel-05'>
          
        </div>
        <div class='panel' id='panel-config'>
          URL : <input id='input-url' type='text'><br>
          Sync : <input id='btt-sync' type='button' value='Sync now'>
        </div>
        <p class='button-config' id='btt-config'></p>
        <p class='button-reload' id='btt-reload'></p> 
      </div>
           
      <script type="text/javascript" src="resources/jquery.js"></script>
      <script type="text/javascript" src="resources/jquery-ui.js"></script>
      <link rel="stylesheet" href="resources/jquery-ui.css">
  
      
      <script src="resources/highcharts/highcharts.js"></script>
      <script src="resources/highcharts/highcharts-3d.js"></script>
      <script src="resources/highcharts/exporting.js"></script>
      
      
      
      <script src="database.js"></script>
      <script>
      
      // URL AJAX
      var url_sync = '';
      
      initURL();
      function initURL(){
        
        if (localStorage.urlsync == undefined) {          
          localStorage.setItem('urlsync','http://localhost/nutrition/');
        }
        
        var temp = localStorage.urlsync;        
        url_sync = temp;
        
        $("#input-url").val(url_sync);
      }
      
      $("#input-url").change(function(){
        
        url_sync = $("#input-url").val();
        localStorage.setItem('urlsync',url_sync);
        
      })
      // End
      
      $("#btt-sync").bind('mousedown', function(){
        if (navigator.onLine){
          if(confirm("Do you want to sync data ?")){          
            syncData();
          }
        }else{
          alert("Thiet bi chua ket noi vao internet!");
        }
      })
      $("#btt-config").bind('mousedown', function(){
        $(".panel").hide();
        $("#panel-config").show();
      })
      $("#btt-reload").bind('mousedown', function(){
        if(confirm("Do you want to reload ?")){
          window.location.href = '';
        }
      })
      
      var list_meal_added = [];
      
      var list_data_user_created = []; // User data-add
      var list_data_autocomplete = []; // Sync data-autocomplete
      var list_data_local = []; // User data-local
      
      var user = {
        'name':'',
        'age':0,
        'sex':0,
        'address':'',
        'phone':'',
        'typework':0,
        'date_created':getCurrentDateCreated()
      }
      
      var result = {
          'energy': 2314,
          'dam': 391.6,
          'duong': 1514.8,
          'beo': 409.5
      }
      
      var total = {
          'pull':100,
          'nangluong':0,
          'dam':0,
          'duong':0,
          'beo':0,
          'vitamin':0,
          'date_created':getCurrentDateCreated()
      }
      
      function getCurrentDateCreated() {
        
        var current = new Date();
        return current.getDate()+"/"+(current.getMonth()+1)+"/"+current.getFullYear()+" "+current.getHours()+":"+current.getMinutes();
        
      }
      var current = 0;
      
      $("#btt-next-intro").bind('mousedown', function() {
        next();
      })
      $("#btt-next-info").bind('mousedown', function() {
        next();  
      })
      $("#btt-next-input").bind('mousedown', function() {
        calPTLK();
        next();
      })
      $("#btt-next-ptlk").bind('mousedown', function() {
        calTPDD();
        next();
      })      
      
      function next() {
          $($(".panel")[current++]).hide();
          $($(".panel")[current]).show();
      }
      
      // USER INPUT
      $('#input-name').change(function(){        
        user.name = $(this).val();        
      });
      $('#input-address').change(function(){        
        user.address = $(this).val();        
      });
      $('#input-phone').change(function(){        
        user.phone = $(this).val();        
      });
      $('#input-age').change(function(){        
        user.age = $(this).val();        
      });
      $('input[name="sex"]:radio').change(function(){        
        user.sex = $(this).val();        
      });
      $('input[name="type-work"]:radio').change(function(){        
        user.typework = $(this).val();        
      });
      
      $('#input-pull').change(function(){        
        total.pull = $(this).val();        
      });
      // END USER INPUT
      
      // List meal
      $("#select-time-meal").change(function(){        
        loadListMeal($("#select-time-meal")[0].value);
      })      
      $("#button-add-meal").bind('mousedown',function(){        
        var qty = $("#input-quantity").val();
        addItem(qty);        
      })
            
      loadListMeal(0);
      function loadListMeal(selectIndex) {
        var temp_array = filter_database[selectIndex];
        var temp_div = '';
        for(var i=0; i<temp_array.length;i++){
          var temp = temp_array[i];          
          temp_div += '<option value="'+i+'">'+temp_array[i].thucan+'</option>'          
        }        
        $("#select-meal").html(temp_div);        
      }
      
      
      
      function addItem(quantity){
        var index_time_meal = $("#select-time-meal")[0].value;
        var index_meal = $("#select-meal")[0].value;
        var temp_thucan = filter_database[index_time_meal][index_meal];
        
        temp_thucan = {
          'time':temp_thucan.buoi,
          'name':temp_thucan.thucan,
          'qty':quantity,
          'nangluong' : roundHundred(temp_thucan.nangluong*quantity),
          'dam' : roundHundred(temp_thucan.dam*quantity*4),
          'duong' : roundHundred(temp_thucan.duong*quantity*4),
          'beo' : roundHundred(temp_thucan.beo*quantity*9),
          'vitamin' : roundHundred(temp_thucan.vitamin*quantity)
        }
        
        list_meal_added.push(temp_thucan)
        
        loadTable();
      }
      // End meal
      
      function roundHundred(val){
        return Math.round(val * 100)/100;
      }
      
      function loadTable(){
        
        var temp_div = '';
        
        for(var i=0;i<list_meal_added.length;i++){
          var temp = list_meal_added[i];
          
          temp_div += "<tr>";
          temp_div +=          
          "<td>"+i+"</td>"
          +"<td>"+temp.time+"</td>"
          +"<td>"+temp.name+"</td>"
          +"<td>"+temp.qty+"</td>"
          
          +"<td>"+temp.nangluong+"</td>"
          +"<td>"+temp.dam+"</td>"
          +"<td>"+temp.duong+"</td>"
          +"<td>"+temp.beo+"</td>"
          +"<td>"+temp.vitamin+"</td>"
          temp_div += "</tr>";
          
          total.nangluong += temp.nangluong;
          total.dam += temp.dam;
          total.duong += temp.duong;
          total.beo += temp.beo;
          total.vitamin += temp.vitamin;
          
        }
        
        total.dam = roundHundred(total.dam);
        total.duong = roundHundred(total.duong);
        total.beo = roundHundred(total.beo);
        total.vitamin = roundHundred(total.vitamin);
        
        var total_energy = total.dam + total.duong + total.beo + total.vitamin;
        var percents = {
          'dam':calPercent(total.dam,total_energy),
          'duong':calPercent(total.duong,total_energy),
          'beo':calPercent(total.beo,total_energy)
        }
        
        temp_div += "<tr>";
        temp_div +=          
        '<td colspan="4">Năng lượng 1 ngày</td>'        
        +"<td>"+total.nangluong+"</td>"
        +"<td>"+total.dam+"</td>"
        +"<td>"+total.duong+"</td>"
        +"<td>"+total.beo+"</td>"
        +"<td>"+total.vitamin+"</td>"
        temp_div += "</tr>";
        
        temp_div += "<tr>";
        temp_div +=          
        '<td colspan="5">Tỉ lệ phần trăm năng lượng trong 1 ngày</td>'        
        +"<td>"+percents.dam+"%</td>"
        +"<td>"+percents.duong+"%</td>"
        +"<td>"+percents.beo+"%</td>"
        +"<td></td>"        
        temp_div += "</tr>";
        
        $(".table tbody").html(temp_div);
      }
      
      function calPercent(val,total){
        return Math.round(val*100/total);
      }
      
      
      
      function calTPDD() {
      
          var nangluong = identifyEnergyLevel();
      
          var enGraphData = calculateGraphData(total.nangluong, nangluong.standardEnergy);
      
          var damGraphData = calculateGraphData(total.dam,
              calculateStandardKcal(nangluong.standardEnergy, STANDARD_DETAIL['dam'].minValue),
              calculateStandardKcal(nangluong.standardEnergy, STANDARD_DETAIL['dam'].maxValue));
      
          var duongGraphData = calculateGraphData(total.duong,
              calculateStandardKcal(nangluong.standardEnergy, STANDARD_DETAIL['duong'].minValue),
              calculateStandardKcal(nangluong.standardEnergy, STANDARD_DETAIL['duong'].maxValue));
      
          var beoGraphData = calculateGraphData(total.beo,
              calculateStandardKcal(nangluong.standardEnergy, STANDARD_DETAIL['beo'].minValue),
              calculateStandardKcal(nangluong.standardEnergy, STANDARD_DETAIL['beo'].maxValue));
      
          $('#container').highcharts({
      
              chart: {
                  type: 'column',
                  options3d: {
                      enabled: true,
                      alpha: 15,
                      beta: 15,
                      viewDistance: 25,
                      depth: 40
                  },
                  marginTop: 80,
                  marginRight: 40
              },
      
              title: {
                  text: 'PHÂN TÍCH THÀNH PHẦN DINH DƯỠNG'
              },
      
              xAxis: {
                  categories: ['Tổng năng lượng', 'Đạm', 'Đường', 'Béo']
              },
      
              yAxis: {
                  allowDecimals: false,
                  min: 0,
                  title: {
                      text: 'KCAL'
                  }
              },
      
              tooltip: {
                  headerFormat: '<b>{point.key}</b><br>',
                  pointFormat: '<span style="color:{series.color}">\u25CF</span> {series.name}: {point.y} / {point.stackTotal}'
              },
      
              plotOptions: {
                  column: {
                      stacking: 'normal',
                      depth: 40
                  }
              },
      
              series: [{
                  name: 'Thừa',
                  data: [enGraphData[2], damGraphData[2], duongGraphData[2], beoGraphData[2]],
                  stack: '1'
              }, {
                  name: 'Thiếu',
                  data: [enGraphData[1], damGraphData[1], duongGraphData[1], beoGraphData[1]],
                  stack: '1'
              }, {
                  name: 'Thực tế',
                  data: [enGraphData[0], damGraphData[0], duongGraphData[0], beoGraphData[0]],
                  stack: '1'
              }]
          });
      }
      
      
      
      
      function calPTLK() {
          var age = ['10', '15', '20', '25', '30', '35', '40', '45', '50', '55', '60', '65', '70', '75', '80', '85'];
          var age_temp = getAge(1990);
          var user_pulls = [];
          var user_pull_data = 5;
          for (var i = 0; i < age.length; i++) {
              if (age_temp <= age[i]) {
                  user_pulls[i] = {
                      y: user_pull_data,
                      marker: {
                          symbol: 'url(http://www.highcharts.com/demo/gfx/sun.png)'
                      }
                  }
                  break;
              } else {
                  user_pulls.push('');
              }
          }
      
          var strongs = [7.0, 6.9, 9.5, 14.5, 18.2, 21.5, 25.2, 26.5, 23.3, 18.3, 13.9, 9.6, 10, 10, 10, 10]
      
          var standards = [3.9, 4.2, 5.7, 8.5, 11.9, 15.2, 17.0, 16.6, 14.2, 10.3, 6.6, 4.8, 10, 10, 10, 10];
      
          var weeks = [3.9, 4.2, 5.7, 8.5, 11.9, 15.2, 17.0, 16.6, 14.2, 10.3, 6.6, 4.8, 10, 10, 10, 10];
      
          $('#container2').highcharts({
              chart: {
                  type: 'spline'
              },
              title: {
                  text: 'PHÂN TÍCH LỰC KÉO'
              },
      
              xAxis: {
                  categories: age
              },
              yAxis: {
                  title: {
                      text: 'Lực kéo'
                  },
                  labels: {
                      formatter: function() {
                          return this.value;
                      }
                  }
              },
              tooltip: {
                  crosshairs: true,
                  shared: true
              },
              plotOptions: {
                  spline: {
                      marker: {
                          radius: 4,
                          lineColor: '#666666',
                          lineWidth: 1
                      }
                  }
              },
              series: [{
                  name: 'Mạnh',
                  data: strongs
      
              }, {
                  name: 'Bình thường',
                  marker: {
                      symbol: 'diamond'
                  },
                  data: standards
              }, {
                  name: 'Yếu',
                  marker: {
                      symbol: 'diamond'
                  },
                  data: weeks
              }, {
                  name: 'Bạn',
                  marker: {
                      symbol: 'diamond'
                  },
                  data: user_pulls
              }]
          });
      }
      
      
      function getAge(yearOfBirth) {
          var currentYear = new Date().getFullYear();
          return currentYear - parseInt(yearOfBirth);
      }
      
      function calculateStandardKcal(totalEnergy, percentage) {
          return ((totalEnergy * percentage) / 100);
      }
      
      function rnd(num) {
          var rs = 0;
          if (!isNaN(num) && num != 0) {
              rs = num.toFixed(1);
          }
          return parseFloat(rs);
      }
      
      function identifyEnergyLevel() {
          // default value
          var standardEnergy = 0;
          var level = LEVEL[0];
      
          // get input
          var actualEnergy = total.nangluong;
          var gender = user.sex;
          var age = getAge(user.age);
          var typeOfWork = user.typework;
          // identify level
          var mapAge = 0;
          for (var a in STANDARD_ENERGY[gender]) {
              if (age > a) {
                  mapAge = a;
                  break;
              }
          }
          if (mapAge > 0) {
              standardEnergy = STANDARD_ENERGY[gender][mapAge][typeOfWork];
      
              if (actualEnergy < standardEnergy) {
                  level = LEVEL[0];
              } else if (actualEnergy > standardEnergy) {
                  level = LEVEL[2];
              } else {
                  level = LEVEL[1];
              }
          }
          return {
              standardEnergy: standardEnergy,
              level: level,
              description: EVALUATE_ENERGY[level].description,
              evaluate: EVALUATE_ENERGY[level].evaluate,
              recommend: EVALUATE_ENERGY[level].recommend
          };
      };
      
      function calculateGraphData(actualEnergy, standardEnergyMin, standardEnergyMax) {
          //console.log("actualEnergy = " + actualEnergy
          //            + ", standardEnergyMin=" + standardEnergyMin
          //            + ", standardEnergyMax=" + standardEnergyMax);
      
          var rs = [0, 0, 0];
          if (standardEnergyMax === undefined || standardEnergyMax === null) {
              standardEnergyMax = standardEnergyMin;
          }
      
          if (actualEnergy < standardEnergyMin) { // less
              rs = [actualEnergy, (standardEnergyMin - actualEnergy), 0];
          } else if (actualEnergy > standardEnergyMax) { // more
              rs = [standardEnergyMax, 0, (actualEnergy - standardEnergyMax)];
          } else { // enough
              rs = [actualEnergy, 0, 0];
          }
      
          console.log(rs)
          return rs;
      };
      
      
      
      initData();
      
      function initData() {
        if (localStorage.list_data_user_created == undefined) {
          
          localStorage.setItem('list_data_user_created','[]')
          
        }else{
          
          var temp = JSON.parse(localStorage.list_data_user_created);          
          list_data_user_created = temp;
          
        }
      }
      function clearData() {
        localStorage.list_data_user_created = "[]";
      }
      
      function saveDataUser(){
        
        var temp_user = {
          'customer': user,
          'record':total          
        };
        
        list_data_user_created.push(temp_user);
        
        localStorage.list_data_user_created = JSON.stringify(list_data_user_created);
      }
      
      function syncData() {
        
        var data_json = JSON.stringify(list_data_user_created);
        
        $.ajax({
            type: "POST",
            url: url_sync+"ajax.php",
            data: {
                'action': 'sync',
                'data': data_json
            },
            success: function (msg) {
                var temp = JSON.parse(msg);
                if(temp.result=='1') {
                  alert('Send data done');
                  // Sync complete
                  clearData(); // Clear data
                  // Get autocomplete list
                  getDataList();
                }
            }
        });
        
      }
      
      function getDataList() {
        $.ajax({
            type: "GET",
            url: url_sync+"ajax.php",
            data: {
                'action': 'sync'
            },
            success: function (msg) {
              var temp = JSON.parse(msg);
              data2Local(temp); // Store list local
              data2AutoComplete(temp); // Store list autocomplete
            }
        });
      }
      
      
      
      initDataLocal();
      function initDataLocal(){
        if (localStorage.list_data_local == undefined) {
          
          localStorage.setItem('list_data_local','[]')
          
        }else{
          
          var temp = JSON.parse(localStorage.list_data_local);          
          list_data_local = temp;
          
        }
      }
      function data2Local(data){
        list_data_local = data;
        
        var data_json = JSON.stringify(list_data_local);
        localStorage.list_data_local = data_json; 
      }
      
      
      initAutocomplete();
      function initAutocomplete(){
        if (localStorage.list_data_autocomplete == undefined) {
          
          localStorage.setItem('list_data_autocomplete','[]')
          
        }
        
        var temp = JSON.parse(localStorage.list_data_autocomplete);          
        list_data_autocomplete = temp;
        
        $( "#input-name" ).autocomplete({
          minLength: 0,
          source: list_data_autocomplete,      
          select: function( event, ui ) {
            
            var temp_data = list_data_local[ui.item.value-1];
            putData2Input(temp_data);
            
            
            //console.log( ui.item.value );
            
            return false;
          }
        });
      }
      
      function putData2Input(data){
        
        //$( "#tags" ).val( data.name );
        $( "#input-name" ).val( data.name );
        $( "#input-address" ).val( data.address );
        $( "#input-phone" ).val( data.phone );
        $( "#input-age" ).val( data.age );
        
        $('input:radio[name=sex][value='+data.sex+']').click();
        $('input:radio[name=type-work][value='+data.typework+']').click();
  
      }
      
      function data2AutoComplete(data){
        list_data_autocomplete = [];
        
        for(var i=0;i<data.length;i++){
          var temp = {'value':(i+1),'label':data[i].name+"-"+data[i].phone};
          list_data_autocomplete.push(temp);          
        }
        // Sync complete
        
        // Save back localstorage : list_data_autocomplete
        var data_json = JSON.stringify(list_data_autocomplete);
        localStorage.list_data_autocomplete = data_json;        
        
      }
      
      </script>
      </body>
  </html>